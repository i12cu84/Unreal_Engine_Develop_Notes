老程序员解 bug 有哪些通用套路？

linux上的一些经验

先看dmsg，程序是崩溃还是oom，同时看看当时有没有硬件和内核告警，比如磁盘满。

找找core文件放哪里了，立即备份core文件，日志和程序binary和动态库。

有zabbix或falcon之类的，把出问题当时的cpu io net 内存的监控数据备份下来。

如果挂了debugfs的信号监控，记录下当时进程间信号通信情况，搞不好是谁手贱帮你把进程kill了，或者shell退出时帮你杀了。

gdb，要会用脚本，用脚本在core中帮助排查复杂数据结构。

make时记得把git hash和编译时间写到程序中，集中测试时频繁更新程序，搞不清出代码版本是很头痛的。

nm链接失败的问题一般用nm看一下就能知道原因。

为代码封装一个方便打印backtrace的宏或函数，只打印地址即可，打函数名代价大又麻烦，打出来的地址用空格分隔，这样多个地址可以直接拷贝给addr2line来看函数名。

怀疑编译优化有问题，就用objdump看看，我遇到过编译优化出死循环的情况。

如果出问题时进程还活着，那得仔细看看/proc下的东西，文件描述符、vma、环境变量。另外如果你不小心删了日志或其他文件，进程未关闭文件的话，可以用文件描述符找回来。

netstat看网络链接的状态，监听端口，进出队列长度，留意下time wait,close wait,sendq,recvq，也许会有惊喜。

lsof看看进程加载了什么位置的动态库，也许有新发现。

/sys下的系统配置，检查下io调度器，ssd一般都用noop，其他调度器可能影响性能。

lspci检查raid卡型号，lsi芯片的话，用megacli64来查看和修改配置，检查下你的raid缓存配置。

sysctl看看系统配置，重点关注tcp缓冲区和sock链接复用的配置，默认的缓冲区大小可能不能发挥万兆的能力。

perf是看性能问题的神器，特别矬的问题用pstack抓几下也能看出来。

irqbalance是坑，一般都关掉，自己把中断只分配到3-4个core上可以发挥更好的万兆网卡性能。所以要留意/proc下的中断统计。

大内存机器注意，glibc默认配置，mmap超过一定数量后可能都走sbrk了，已经free的内存可能碎片化无法还给系统也不能重用，自己管理内存的话一般都把mmap的大小和个数都调大，避免走sbrk。所以看/proc下的虚存使用情况很必要。

怀疑网络或磁盘问题，用iperf和fio亲自测试看看。

高并发或内存池管理下的内存越界，valgrind基本没用，mprotect可以帮忙，但是要改代码做对齐。另外就是管教结构的头尾可以用宏控制加magic number，运气好的话看一眼被破坏的内存就知道是谁占用的了。

日志中把微秒时间，文件名，函数名，行号都打出来，关键时候有大用处。

其他想起来再补充。。

最后，老司机的经验是做好防御性编程，把日志做好，即方便查问题也方便甩锅。。